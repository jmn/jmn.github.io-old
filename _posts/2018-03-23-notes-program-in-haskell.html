---
title: "Note recording haskell program"
layout: "post"
CATEGORY: "Haskell"
ON: "2018-03-23 09:06"
---
<div id="content">
<div class="outline-text-2" id="text-1">
<p>
A small haskell program that manages short notes in a sqlite database. Uses <a href="https://hackage.haskell.org/package/sqlite-simple">sqlite-simple</a> and <a href="https://hackage.haskell.org/package/cmdargs">CmdArgs</a>.
</p>


<div class="org-src-container">
{% highlight haskell %}
<code class="src src-haskell">

{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE DeriveDataTypeable #-}

module Main where

import Lib
import System.Environment (getArgs)
import Database.SQLite.Simple
import System.Console.CmdArgs
import Data.List hiding (delete)
import Data.Time.Format.Human
import Data.Time
import Data.Time.Format
import Control.Monad (when)

data Options = Options
    { inputMode :: Bool
    , message :: String
    , delete :: Integer
    , humanTime :: Bool
    , tags :: Maybe String
    , update :: Integer
    , showTag :: Maybe String
    } deriving (Data, Typeable)

options :: Options
options =
    Options
    { inputMode = False &amp;= typ "Input mode" &amp;= help "Toggle input mode"
    , message = def &amp;= typ "message" &amp;= opt ("" :: String) &amp;= args
    , delete = def &amp;= typ "[number]" &amp;= help "Delete a note."
    , humanTime =
        False &amp;= typ "Relative time" &amp;= help "Show time relative to now in human readable format."
    , tags = def &amp;= typ "tags" &amp;= help "Tag a note."
    , update = def &amp;= typ "[number]" &amp;= help "Modify a note."
    , showTag = def &amp;= typ "TAG" &amp;= help "Show entries with given tag."
    } &amp;=
    summary "n notes" &amp;=
    program "n"

data TestField = TestField
    { id_ :: Int
    , time :: String
    , note :: String
    , tags' :: Maybe String
    } deriving (Show)

instance FromRow TestField where
    fromRow = TestField &lt;$&gt; field &lt;*&gt; field &lt;*&gt; field &lt;*&gt; field

instance ToRow TestField where
    toRow (TestField id_ date_added str str') = toRow (id_, date_added, str, str')

dbPut :: Connection -&gt; String -&gt; Maybe String -&gt; IO ()
dbPut conn val mTags =
    case mTags of
        Nothing -&gt;
            execute
                conn
                "INSERT INTO test (date_added, str) \
        \VALUES (datetime('now'), ?)"
                (Only (val :: String))
        tags -&gt;
            execute
                conn
                "INSERT INTO test (date_added, str, tags) \
        \VALUES (datetime('now'), ?, ?)"
                (val :: String, tags)

deleteRecord :: Connection -&gt; Integer -&gt; IO ()
deleteRecord conn x = execute conn "DELETE FROM test WHERE ID = (?)" (Only x)

showNote :: Bool -&gt; TestField -&gt; IO ()
showNote humanizeTime x = do
    time' &lt;- if humanizeTime then
        do let t = parseTimeOrError False defaultTimeLocale "%F %T" (time x) :: UTCTime
           humanReadableTime t
    else
           return (time x)
    t &lt;-
        case tags' x of
            Nothing -&gt; return ""
            Just xs -&gt; return $ "#" ++ xs

    let msg = note x ++ " " ++ t
    let o = intercalate " | " [show (id_ x), time', msg]
    print o

createTable conn =
    execute_
        conn
        "CREATE TABLE IF NOT EXISTS \
        \test (id INTEGER PRIMARY KEY, \
        \date_added DATETIME DEFAULT CURRENT_TIMESTAMP, \
        \str TEXT, \
        \tags TEXT)"

main :: IO ()
main = do
    opts &lt;- cmdArgs options
    conn &lt;- open "test.db"
    createTable conn
    when (delete opts /= 0) (deleteRecord conn (delete opts))
    when (message opts /= "") (dbPut conn (message opts) (tags opts))
    when
        (inputMode opts)
        (do content &lt;- getContents
            dbPut conn content (tags opts))
    r &lt;-
        case showTag opts of
            Nothing -&gt; query_ conn "SELECT * from test" :: IO [TestField]
            Just x -&gt; query conn "SELECT * from test WHERE tags LIKE ?" (Only x) :: IO [TestField]
    if humanTime opts
        then mapM_ (showNote True) r
        else mapM_ (showNote False) r
    close conn
   
</code>
{% endhighlight %}
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2018-03-23 Fri 09:03</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
