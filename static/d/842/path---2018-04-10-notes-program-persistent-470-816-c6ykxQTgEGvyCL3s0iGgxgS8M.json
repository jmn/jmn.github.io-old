{"data":{"markdownRemark":{"html":"<p>Here's a version of <a href=\"/2018/03/24/notes-program-in-haskell\">the previous notes program</a> that uses Persistent. </p>\n<!--more-->\n<p>The imports are: </p>\n<ul>\n<li>text</li>\n<li>cmdargs</li>\n<li>friendly-time</li>\n<li>time</li>\n<li>persistent</li>\n<li>persistent-sqlite</li>\n<li>persistent-template</li>\n<li>transformers</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"haskell\"><pre class=\"language-haskell\"><code class=\"language-haskell\"><span class=\"token comment\">{-# LANGUAGE DeriveDataTypeable #-}</span>\n<span class=\"token comment\">{-# LANGUAGE EmptyDataDecls #-}</span>\n<span class=\"token comment\">{-# LANGUAGE FlexibleContexts #-}</span>\n<span class=\"token comment\">{-# LANGUAGE GADTs #-}</span>\n<span class=\"token comment\">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>\n<span class=\"token comment\">{-# LANGUAGE MultiParamTypeClasses #-}</span>\n<span class=\"token comment\">{-# LANGUAGE OverloadedStrings #-}</span>\n<span class=\"token comment\">{-# LANGUAGE QuasiQuotes #-}</span>\n<span class=\"token comment\">{-# LANGUAGE TemplateHaskell #-}</span>\n<span class=\"token comment\">{-# LANGUAGE TypeFamilies #-}</span>\n\n<span class=\"token keyword\">module</span> <span class=\"token constant\">Main</span> <span class=\"token keyword\">where</span>\n\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> System.Console.CmdArgs</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Control.Monad</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">when</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Database.Persist</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Database.Persist.TH</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Database.Persist.Sqlite</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Control.Monad.IO.Class</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">liftIO</span><span class=\"token punctuation\">)</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Control.Monad.Trans.Reader</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Data.Time</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Data.List</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">intercalate</span><span class=\"token punctuation\">)</span>\n<span class=\"token import_statement\"><span class=\"token keyword\">import</span> Data.Time.Format.Human</span>\n\n<span class=\"token hvariable\">share</span>\n    <span class=\"token punctuation\">[</span><span class=\"token hvariable\">mkPersist</span> <span class=\"token hvariable\">sqlSettings</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">mkMigrate</span> <span class=\"token string\">\"migrateAll\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token hvariable\">persistLowerCase</span><span class=\"token operator\">|</span>\n<span class=\"token constant\">Note</span>\n    <span class=\"token hvariable\">message</span> <span class=\"token constant\">String</span>\n    <span class=\"token hvariable\">tags</span> <span class=\"token constant\">String</span> <span class=\"token constant\">Maybe</span>\n    <span class=\"token hvariable\">createdAt</span> <span class=\"token constant\">UTCTime</span> <span class=\"token hvariable\">default</span><span class=\"token operator\">=</span><span class=\"token constant\">CURRENT_TIME</span>\n    <span class=\"token keyword\">deriving</span> <span class=\"token constant\">Show</span>\n<span class=\"token operator\">|</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">data</span> <span class=\"token constant\">Options</span> <span class=\"token operator\">=</span> <span class=\"token constant\">Options</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token hvariable\">inputMode</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Bool</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">message</span> <span class=\"token operator\">::</span> <span class=\"token constant\">String</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">delete</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Integer</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">humanTime</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Bool</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">tags</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Maybe</span> <span class=\"token constant\">String</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">update</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Integer</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">showTag</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Maybe</span> <span class=\"token constant\">String</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">deriving</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">Data</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">Typeable</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token hvariable\">options</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Options</span>\n<span class=\"token hvariable\">options</span> <span class=\"token operator\">=</span>\n    <span class=\"token constant\">Options</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token hvariable\">inputMode</span> <span class=\"token operator\">=</span> <span class=\"token constant\">False</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">typ</span> <span class=\"token string\">\"Input mode\"</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">help</span> <span class=\"token string\">\"Toggle input mode\"</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">message</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">def</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">typ</span> <span class=\"token string\">\"message\"</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">opt</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span> <span class=\"token operator\">::</span> <span class=\"token constant\">String</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">args</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">Main.delete</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">def</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">typ</span> <span class=\"token string\">\"[number]\"</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">help</span> <span class=\"token string\">\"Delete a note.\"</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">humanTime</span> <span class=\"token operator\">=</span>\n        <span class=\"token constant\">False</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">typ</span> <span class=\"token string\">\"Relative time\"</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">help</span> <span class=\"token string\">\"Show time relative to now in human readable format.\"</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">tags</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">def</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">typ</span> <span class=\"token string\">\"tags\"</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">help</span> <span class=\"token string\">\"Tag a note.\"</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">Main.update</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">def</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">typ</span> <span class=\"token string\">\"[number]\"</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">help</span> <span class=\"token string\">\"Modify a note.\"</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token hvariable\">showTag</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">def</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">typ</span> <span class=\"token string\">\"TAG\"</span> <span class=\"token operator\">&amp;=</span> <span class=\"token hvariable\">help</span> <span class=\"token string\">\"Show entries with given tag.\"</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">&amp;=</span>\n    <span class=\"token hvariable\">summary</span> <span class=\"token string\">\"n notes\"</span> <span class=\"token operator\">&amp;=</span>\n    <span class=\"token hvariable\">program</span> <span class=\"token string\">\"n\"</span>\n\n<span class=\"token hvariable\">showNote</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Bool</span> <span class=\"token operator\">-></span> <span class=\"token constant\">Entity</span> <span class=\"token constant\">Note</span> <span class=\"token operator\">-></span> <span class=\"token constant\">IO</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token hvariable\">showNote</span> <span class=\"token hvariable\">humanizeTime</span> <span class=\"token hvariable\">note</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">do</span>\n    <span class=\"token keyword\">let</span> <span class=\"token hvariable\">n</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">entityVal</span> <span class=\"token hvariable\">note</span>\n    <span class=\"token keyword\">let</span> <span class=\"token hvariable\">t</span>' <span class=\"token operator\">=</span> <span class=\"token hvariable\">noteCreatedAt</span> <span class=\"token hvariable\">n</span>\n    <span class=\"token keyword\">let</span> <span class=\"token hvariable\">key</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">show</span> <span class=\"token operator\">$</span> <span class=\"token hvariable\">fromSqlKey</span> <span class=\"token operator\">$</span> <span class=\"token hvariable\">entityKey</span> <span class=\"token hvariable\">note</span>\n    <span class=\"token hvariable\">time</span> <span class=\"token operator\">&lt;-</span>\n        <span class=\"token keyword\">if</span> <span class=\"token hvariable\">humanizeTime</span>\n            <span class=\"token keyword\">then</span> <span class=\"token hvariable\">humanReadableTime</span> <span class=\"token hvariable\">t</span>'\n            <span class=\"token keyword\">else</span> <span class=\"token builtin\">return</span> <span class=\"token operator\">$</span> <span class=\"token builtin\">show</span> <span class=\"token hvariable\">t</span>'\n    <span class=\"token hvariable\">t</span> <span class=\"token operator\">&lt;-</span>\n        <span class=\"token keyword\">case</span> <span class=\"token hvariable\">noteTags</span> <span class=\"token hvariable\">n</span> <span class=\"token keyword\">of</span>\n            <span class=\"token constant\">Nothing</span> <span class=\"token operator\">-></span> <span class=\"token builtin\">return</span> <span class=\"token string\">\"\"</span>\n            <span class=\"token constant\">Just</span> <span class=\"token hvariable\">xs</span> <span class=\"token operator\">-></span> <span class=\"token builtin\">return</span> <span class=\"token operator\">$</span> <span class=\"token string\">\"#\"</span> <span class=\"token operator\">++</span> <span class=\"token hvariable\">xs</span>\n    <span class=\"token keyword\">let</span> <span class=\"token hvariable\">o</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">intercalate</span> <span class=\"token string\">\" | \"</span> <span class=\"token punctuation\">[</span><span class=\"token hvariable\">key</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">time</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">show</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">noteMessage</span> <span class=\"token hvariable\">n</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">t</span><span class=\"token punctuation\">]</span>\n    <span class=\"token builtin\">print</span> <span class=\"token hvariable\">o</span>\n\n\n<span class=\"token hvariable\">asSqlBackendReader</span> <span class=\"token operator\">::</span> <span class=\"token constant\">ReaderT</span> <span class=\"token constant\">SqlBackend</span> <span class=\"token hvariable\">m</span> <span class=\"token hvariable\">a</span> <span class=\"token operator\">-></span> <span class=\"token constant\">ReaderT</span> <span class=\"token constant\">SqlBackend</span> <span class=\"token hvariable\">m</span> <span class=\"token hvariable\">a</span>\n<span class=\"token hvariable\">asSqlBackendReader</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">id</span>\n\n<span class=\"token hvariable\">main</span> <span class=\"token operator\">::</span> <span class=\"token constant\">IO</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token hvariable\">main</span> <span class=\"token operator\">=</span>\n    <span class=\"token hvariable\">runSqlite</span> <span class=\"token string\">\"testn.db\"</span> <span class=\"token operator\">$</span>\n    <span class=\"token hvariable\">asSqlBackendReader</span> <span class=\"token operator\">$</span>\n    <span class=\"token keyword\">do</span> <span class=\"token hvariable\">opts</span> <span class=\"token operator\">&lt;-</span> <span class=\"token hvariable\">liftIO</span> <span class=\"token operator\">$</span> <span class=\"token hvariable\">cmdArgs</span> <span class=\"token hvariable\">options</span>\n       <span class=\"token hvariable\">runMigration</span> <span class=\"token hvariable\">migrateAll</span>\n       <span class=\"token hvariable\">time</span> <span class=\"token operator\">&lt;-</span> <span class=\"token hvariable\">liftIO</span> <span class=\"token hvariable\">getCurrentTime</span>\n       <span class=\"token hvariable\">when</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">message</span> <span class=\"token hvariable\">opts</span> <span class=\"token operator\">/=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">$</span> <span class=\"token hvariable\">void</span> <span class=\"token operator\">$</span> <span class=\"token hvariable\">insert</span> <span class=\"token operator\">$</span> <span class=\"token constant\">Note</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">message</span> <span class=\"token hvariable\">opts</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">tags</span> <span class=\"token hvariable\">opts</span><span class=\"token punctuation\">)</span> <span class=\"token hvariable\">time</span>\n       <span class=\"token hvariable\">when</span>\n           <span class=\"token punctuation\">(</span><span class=\"token hvariable\">inputMode</span> <span class=\"token hvariable\">opts</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">(</span><span class=\"token keyword\">do</span> <span class=\"token hvariable\">content</span> <span class=\"token operator\">&lt;-</span> <span class=\"token hvariable\">liftIO</span> <span class=\"token builtin\">getContents</span>\n               <span class=\"token hvariable\">void</span> <span class=\"token operator\">$</span> <span class=\"token hvariable\">insert</span> <span class=\"token operator\">$</span> <span class=\"token constant\">Note</span> <span class=\"token hvariable\">content</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">tags</span> <span class=\"token hvariable\">opts</span><span class=\"token punctuation\">)</span> <span class=\"token hvariable\">time</span>\n               <span class=\"token builtin\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n       <span class=\"token hvariable\">when</span>\n           <span class=\"token punctuation\">(</span><span class=\"token hvariable\">Main.delete</span> <span class=\"token hvariable\">opts</span> <span class=\"token operator\">/=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">(</span><span class=\"token keyword\">do</span> <span class=\"token keyword\">let</span> <span class=\"token hvariable\">key</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">toSqlKey</span> <span class=\"token operator\">$</span> <span class=\"token builtin\">fromIntegral</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">Main.delete</span> <span class=\"token hvariable\">opts</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Key</span> <span class=\"token constant\">Note</span>\n               <span class=\"token hvariable\">Database.Persist.Sqlite.delete</span> <span class=\"token hvariable\">key</span><span class=\"token punctuation\">)</span>\n       <span class=\"token hvariable\">notes</span> <span class=\"token operator\">&lt;-</span>\n           <span class=\"token keyword\">case</span> <span class=\"token hvariable\">showTag</span> <span class=\"token hvariable\">opts</span> <span class=\"token keyword\">of</span>\n               <span class=\"token constant\">Nothing</span> <span class=\"token operator\">-></span> <span class=\"token hvariable\">selectList</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">Asc</span> <span class=\"token constant\">NoteCreatedAt</span><span class=\"token punctuation\">]</span>\n               <span class=\"token constant\">Just</span> <span class=\"token hvariable\">x</span> <span class=\"token operator\">-></span> <span class=\"token hvariable\">selectList</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">NoteTags</span> <span class=\"token operator\">==.</span> <span class=\"token constant\">Just</span> <span class=\"token hvariable\">x</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">Asc</span> <span class=\"token constant\">NoteCreatedAt</span><span class=\"token punctuation\">]</span>\n       <span class=\"token keyword\">if</span> <span class=\"token hvariable\">humanTime</span> <span class=\"token hvariable\">opts</span>\n           <span class=\"token keyword\">then</span> <span class=\"token hvariable\">liftIO</span> <span class=\"token operator\">$</span> <span class=\"token builtin\">mapM_</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">showNote</span> <span class=\"token constant\">True</span><span class=\"token punctuation\">)</span> <span class=\"token hvariable\">notes</span>\n           <span class=\"token keyword\">else</span> <span class=\"token hvariable\">liftIO</span> <span class=\"token operator\">$</span> <span class=\"token builtin\">mapM_</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">showNote</span> <span class=\"token constant\">False</span><span class=\"token punctuation\">)</span> <span class=\"token hvariable\">notes</span></code></pre></div>","frontmatter":{"title":"Haskell Persistent note recording program"},"fields":{"date":"2018-04-10"}}},"pageContext":{"slug":"/2018/04/10/notes-program-persistent/"}}